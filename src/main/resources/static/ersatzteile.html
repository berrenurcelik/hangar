<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Ersatzteile anzeigen – Hangar Management System</title>
  <link rel="stylesheet" href="css/styles.css" />
  <link rel="stylesheet" href="css/auth.css" />
</head>
<body>
  <div class="container">
    <header class="app-header">
      <h1>✈️ Ersatzteile anzeigen</h1>
      <div id="auth-header" class="auth-header"></div>
    </header>

    <div class="content">
      <div id="parts-alert"></div>
      
      <!-- Funktion „Ersatzteile anzeigen“, Such-/Filtermaske -->
      <div id="search-section">
        <h2>Ersatz- und Zubehörteile suchen</h2>
        <p class="hint">Geben Sie Suchkriterien ein (z.B. Name oder Beschreibung). Leer = alle verfügbaren Teile.</p>
        <form id="search-form" onsubmit="doSearch(event)">
          <div class="form-group">
            <label for="search-criteria">Suchkriterien</label>
            <input type="text" id="search-criteria" placeholder="z.B. Propeller, Filter, LED..." />
          </div>
          <button type="submit">Suche starten</button>
        </form>
      </div>

      <!-- Liste der gefundenen Teile, Keine Treffer -->
      <div id="results-section" style="display: none;">
        <h2>Suchergebnisse</h2>
        <p id="no-results-msg" class="alert-info" style="display: none;">
          Die Suche hat keine Ergebnisse geliefert. Bitte passen Sie Ihre Suchkriterien an und versuchen Sie es erneut.
        </p>
        <table class="data-table" id="results-table">
          <thead>
            <tr>
              <th>Artikel</th>
              <th>Beschreibung</th>
              <th>Preis</th>
              <th>Verfügbar</th>
              <th>Anbieter</th>
              <th>Aktion</th>
            </tr>
          </thead>
          <tbody id="results-table-body"></tbody>
        </table>
      </div>

      <!-- Detailinformationen + Reservieren -->
      <div id="detail-section" style="display: none;">
        <h2>Artikeldetails</h2>
        <div class="detail-section">
          <p><strong>Name:</strong> <span id="detail-name"></span></p>
          <p><strong>Beschreibung:</strong> <span id="detail-description"></span></p>
          <p><strong>Preis:</strong> <span id="detail-price"></span> €</p>
          <p><strong>Menge (Lager):</strong> <span id="detail-quantity"></span></p>
          <p><strong>Verfügbar:</strong> <span id="detail-availability"></span></p>
          <p><strong>Flugzeugteileanbieter:</strong> <span id="detail-provider"></span></p>
        </div>
        <!-- Reservieren-Button, Erfolgsmeldung -->
        <div id="detail-actions">
          <button type="button" id="btn-reservieren" class="btn-reservieren">Reservieren</button>
        </div>
        <div id="detail-reservation-success" class="alert alert-success" style="display: none;">
          <h3>Reservierung erfolgreich</h3>
          <p>Die Reservierung wurde angelegt. Der Flugzeugteileanbieter wurde über die Reservierung informiert.</p>
        </div>
        <div class="nav-actions">
          <a href="#" id="back-to-results" class="btn-primary">Zurück zur Liste</a>
          <a href="profile.html" class="btn-primary">Zum Profil</a>
        </div>
      </div>

      <!--  Bestätigungsdialog mit Konditionen -->
      <div id="reservation-dialog" class="modal-overlay" style="display: none;">
        <div class="modal-content">
          <h3>Reservierung bestätigen</h3>
          <p id="dialog-article-name"></p>
          <p id="dialog-conditions">Preis: <span id="dialog-price"></span> € · Menge: <span id="dialog-qty"></span></p>
          <p class="dialog-note">Der Flugzeugteileanbieter wird automatisch über die Reservierung informiert.</p>
          <div class="modal-actions">
            <button type="button" id="dialog-confirm" class="btn-primary">Reservierung bestätigen</button>
            <button type="button" id="dialog-cancel" class="btn-secondary">Abbrechen</button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div class="bottom-nav">
    <a href="index.html" class="bottom-nav__item">Home</a>
    <a href="profile.html" class="bottom-nav__item">Profil</a>
  </div>

  <script src="js/auth.js"></script>
  <script>
    let currentPart = null;

    (function() {
      const user = getCurrentUser();
      const authHeader = document.getElementById('auth-header');

      if (!user || user.role !== 'AIRCRAFT_OWNER') {
        window.location.href = 'login.html';
        return;
      }

      if (authHeader) {
        authHeader.innerHTML = '<span class="auth-user">Hallo, ' + (user.name || user.email) + '</span> <a href="profile.html" class="auth-link">Profil</a> <a href="#" onclick="logout(); return false;" class="auth-link">Abmelden</a>';
      }
    })();

    async function doSearch(event) {
      event.preventDefault();
      const criteria = (document.getElementById('search-criteria').value || '').trim();
      const alertEl = document.getElementById('parts-alert');
      document.getElementById('results-section').style.display = 'block';
      document.getElementById('detail-section').style.display = 'none';
      document.getElementById('no-results-msg').style.display = 'none';

      try {
        const url = criteria
          ? API_BASE + '/parts/search?criteria=' + encodeURIComponent(criteria)
          : API_BASE + '/parts';
        const res = await fetch(url);
        if (!res.ok) throw new Error('Suche fehlgeschlagen');
        const parts = await res.json();
        const tbody = document.getElementById('results-table-body');
        if (!parts || parts.length === 0) {
          document.getElementById('no-results-msg').style.display = 'block';
          tbody.innerHTML = '';
          return;
        }
        document.getElementById('no-results-msg').style.display = 'none';
        tbody.innerHTML = parts.map(p => {
          const prov = p.partsProvider || {};
          return `
            <tr>
              <td>${p.name || '-'}</td>
              <td>${(p.description || '-').substring(0, 50)}${(p.description || '').length > 50 ? '…' : ''}</td>
              <td>${p.price != null ? p.price + ' €' : '-'}</td>
              <td>${p.quantity != null ? p.quantity : '-'}</td>
              <td>${prov.name || '-'}</td>
              <td><a href="#" class="link-detail" data-id="${p.id}">Details</a></td>
            </tr>
          `;
        }).join('');
        tbody.querySelectorAll('.link-detail').forEach(a => {
          a.addEventListener('click', function(e) {
            e.preventDefault();
            showDetail(Number(this.getAttribute('data-id')));
          });
        });
      } catch (err) {
        console.error(err);
        showAuthAlert(alertEl, 'Fehler bei der Suche.', 'error');
        document.getElementById('no-results-msg').style.display = 'block';
      }
    }

    async function showDetail(id) {
      document.getElementById('search-section').style.display = 'none';
      document.getElementById('results-section').style.display = 'none';
      document.getElementById('detail-section').style.display = 'block';
      document.getElementById('detail-reservation-success').style.display = 'none';
      const alertEl = document.getElementById('parts-alert');
      try {
        const res = await fetch(API_BASE + '/parts/' + id);
        if (!res.ok) throw new Error('Artikel nicht gefunden');
        const p = await res.json();
        currentPart = p;
        const prov = p.partsProvider || {};
        document.getElementById('detail-name').textContent = p.name || '-';
        document.getElementById('detail-description').textContent = p.description || '-';
        document.getElementById('detail-price').textContent = p.price != null ? p.price : '-';
        document.getElementById('detail-quantity').textContent = p.quantity != null ? p.quantity : '-';
        document.getElementById('detail-availability').textContent = p.availability ? 'Ja' : 'Nein';
        document.getElementById('detail-provider').textContent = prov.name ? (prov.name + (prov.contact ? ' – ' + prov.contact : '')) : '-';
        const btnRes = document.getElementById('btn-reservieren');
        const canReserve = (p.quantity != null && p.quantity > 0) && (p.availability === true || p.availability === 'true');
        btnRes.style.display = canReserve ? 'inline-block' : 'none';
      } catch (err) {
        console.error(err);
        showAuthAlert(alertEl, 'Artikel konnte nicht geladen werden.', 'error');
      }
    }

    document.getElementById('btn-reservieren').addEventListener('click', function() {
      if (!currentPart || !currentPart.partsProvider || !currentPart.partsProvider.id) return;
      document.getElementById('dialog-article-name').textContent = 'Artikel: ' + (currentPart.name || '-');
      document.getElementById('dialog-price').textContent = currentPart.price != null ? currentPart.price : '-';
      document.getElementById('dialog-qty').textContent = '1';
      document.getElementById('reservation-dialog').style.display = 'flex';
    });

    document.getElementById('dialog-cancel').addEventListener('click', function() {
      document.getElementById('reservation-dialog').style.display = 'none';
    });

    document.getElementById('dialog-confirm').addEventListener('click', async function() {
      const alertEl = document.getElementById('parts-alert');
      const user = getCurrentUser();
      if (!user || !user.email || !currentPart) return;
      const quantity = 1;
      try {
        const profileRes = await fetch(API_BASE + '/aircraft-owner/profile/by-email?email=' + encodeURIComponent(user.email));
        if (!profileRes.ok) {
          showAuthAlert(alertEl, 'Profil konnte nicht geladen werden.', 'error');
          return;
        }
        const profile = await profileRes.json();
        const res = await fetch(API_BASE + '/article-reservation/create', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            acoId: profile.id,
            psId: currentPart.partsProvider.id,
            sparePartID: currentPart.id,
            quantity: quantity,
            status: 'RESERVED'
          })
        });
        const data = await res.json().catch(function() { return {}; });
        document.getElementById('reservation-dialog').style.display = 'none';
        if (res.ok && data.id) {
          document.getElementById('detail-reservation-success').style.display = 'block';
          document.getElementById('btn-reservieren').style.display = 'none';
          showAuthAlert(alertEl, 'Reservierung wurde angelegt. Der Flugzeugteileanbieter wurde informiert.', 'success');
          currentPart.quantity = (currentPart.quantity || 0) - quantity;
          if (currentPart.quantity <= 0) currentPart.availability = false;
          document.getElementById('detail-quantity').textContent = currentPart.quantity;
          document.getElementById('detail-availability').textContent = currentPart.availability ? 'Ja' : 'Nein';
        } else {
          if (data.error === 'NOT_AVAILABLE' || data.message && data.message.indexOf('Zwischenzeit') !== -1) {
            showAuthAlert(alertEl, 'Der Artikel ist in der Zwischenzeit reserviert oder entfernt worden. Sie bleiben in der Detailansicht.', 'error');
          } else {
            showAuthAlert(alertEl, 'Reservierung fehlgeschlagen.', 'error');
          }
        }
      } catch (err) {
        console.error(err);
        document.getElementById('reservation-dialog').style.display = 'none';
        showAuthAlert(alertEl, 'Fehler beim Anlegen der Reservierung.', 'error');
      }
    });

    document.getElementById('back-to-results').addEventListener('click', function(e) {
      e.preventDefault();
      document.getElementById('detail-section').style.display = 'none';
      document.getElementById('search-section').style.display = 'block';
      document.getElementById('results-section').style.display = 'block';
    });
  </script>
  <style>
    .hint { color: #666; margin-bottom: 15px; }
    .detail-section { margin: 20px 0; padding: 20px; background: #f9f9f9; border-radius: 8px; }
    .detail-section p { margin: 10px 0; }
    .btn-primary { display: inline-block; padding: 12px 24px; background: #667eea; color: white; text-decoration: none; border-radius: 6px; margin-right: 10px; border: none; cursor: pointer; }
    .btn-reservieren { padding: 12px 24px; background: #48bb78; color: white; border: none; border-radius: 6px; cursor: pointer; font-size: 1em; margin-right: 10px; }
    .btn-reservieren:hover { background: #38a169; }
    .btn-secondary { padding: 12px 24px; background: transparent; color: #667eea; border: 1px solid #667eea; border-radius: 6px; cursor: pointer; margin-right: 10px; }
    .nav-actions { margin-top: 24px; }
    .alert-info { padding: 12px; background: #eff6ff; border-radius: 6px; color: #1e40af; margin-bottom: 16px; }
    .alert-success { padding: 16px; background: #c6f6d5; border-radius: 8px; color: #22543d; margin: 16px 0; }
    .link-detail { color: #667eea; }
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.4); display: flex; align-items: center; justify-content: center; z-index: 1000; }
    .modal-content { background: white; padding: 24px; border-radius: 8px; max-width: 420px; }
    .modal-content h3 { margin-top: 0; }
    .dialog-note { font-size: 0.95em; color: #4a5568; margin: 12px 0; }
    .modal-actions { margin-top: 20px; }
  </style>
</body>
</html>
